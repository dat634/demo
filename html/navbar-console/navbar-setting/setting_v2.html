<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Setting v2 - H·ªçcVui</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="../../../css/setting.css">
<link rel="stylesheet" href="../../../css/light_mode.css">
</head>
<body>
<div id="navbar"></div>

  <div class="container">
    <aside>
      <div class="user-mini">
        <img id="miniAvatar" class="avatar-small" src="https://i.imgur.com/ZCk5pQp.png" alt="avatar">
        <div class="email" id="miniEmail">‚Äî</div>
      </div>

      <nav>
        <button class="tab-btn active" data-tab="profileTab">üë§ H·ªì s∆°</button>
        <button class="tab-btn" data-tab="themeTab">üé® Giao di·ªán</button>
        <button class="tab-btn" data-tab="gameTab">üéÆ Tr√≤ ch∆°i</button>
        <button class="tab-btn" data-tab="badgeTab">üèÜ Th√†nh t√≠ch</button>
        <button class="tab-btn" data-tab="accountTab">‚öôÔ∏è T√†i kho·∫£n</button>
        <a class="tab-btn" href="../../mainAll/main-lobby.html" style="text-decoration: none;"> ‚¨Ö Back to main page</a>
      </nav>

      <div class="footer-actions">
        <button id="logoutBtn" class="btn ghost">ƒêƒÉng xu·∫•t</button>
        <button id="deleteAccountBtn" class="btn ghost">X√≥a t√†i kho·∫£n</button>
      </div>
    </aside>

    <main class="main">
      <div class="grid">
        <div class="left">
          <!-- PROFILE -->
          <div id="profileTab" class="card tab-content active">
            <h3>H·ªì s∆° c·ªßa b·∫°n</h3>
            <div style="display:flex;gap:18px;align-items:center">
              <img id="avatarPreview" class="avatar-preview" src="../../../src/ex1.png" alt="avatar">
              <div style="flex:1">
                <div class="label">T·∫£i ·∫£nh ƒë·∫°i di·ªán (‚â§ 2MB)</div>
                <input id="avatarInput" type="file" accept="image/*">
                <div class="label">T√™n hi·ªÉn th·ªã</div>
                <input id="displayName" class="input" placeholder="T√™n hi·ªÉn th·ªã">
                <div class="label">Gi·ªõi thi·ªáu</div>
                <textarea id="bio" class="input" placeholder="M√¥ t·∫£ ng·∫Øn..."></textarea>
                <div style="display:flex;gap:8px;margin-top:8px">
                  <button id="saveProfileBtn" class="btn">L∆∞u h·ªì s∆°</button>
                  <button id="clearProfileBtn" class="btn ghost">Reset h·ªì s∆°</button>
                </div>
              </div>
            </div>
          </div>

          <!-- THEME -->
          <div id="themeTab" class="card tab-content">
            <h3>Giao di·ªán</h3>
            <div class="label">Ch·∫ø ƒë·ªô</div>

              <select id="themeMode">
                <option value="dark">Dark</option>
                <option value="light">Light</option>
              </select>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="saveThemeBtn" class="btn">L∆∞u giao di·ªán</button>
              <button id="resetThemeBtn" class="btn ghost">Reset giao di·ªán</button>
            </div>
          </div>

          <!-- GAME -->
          <div id="gameTab" class="card tab-content">
            <h3>C√†i ƒë·∫∑t tr√≤ ch∆°i</h3>
            <div class="label">M·ª©c ƒë·ªô m·∫∑c ƒë·ªãnh</div>
            <select id="defaultLevel" class="input">
              <option value="A1">A1</option><option value="A2">A2</option><option value="B1">B1</option><option value="B2">B2</option><option value="C1">C1</option><option value="C2">C2</option>
            </select>
            <label style="margin-top:8px"><input id="soundToggle" type="checkbox" checked> B·∫≠t √¢m thanh</label>
            <label><input id="effectToggle" type="checkbox" checked> Hi·ªáu ·ª©ng chuy·ªÉn c·∫£nh</label>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="saveGameBtn" class="btn">L∆∞u c√†i ƒë·∫∑t tr√≤ ch∆°i</button>
              <button class="btn"><a href="../../playground/MainConsole_Playground.html" style="text-decoration: none; color: #111;"><p>Ch∆°i ngay</p></a></button>
               <button id="resetGameBtn" class="btn ghost">Reset tr√≤ ch∆°i</button>
            </div>
          </div>
          <!-- BADGES -->
          <div id="badgeTab" class="card tab-content">
            <h3>Th√†nh t√≠ch</h3>
            <div id="badgesWrap" class="badges"><div class="small">ƒêang t·∫£i huy hi·ªáu...</div></div>
          </div>

          <!-- ACCOUNT -->
          <div id="accountTab" class="card tab-content">
            <h3>T√†i kho·∫£n</h3>
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div class="small">Email</div>
                <div id="userEmailDisplay" style="font-weight:700">‚Äî</div>
              </div>
              <div style="display:flex;flex-direction:column;gap:8px">
                <button id="changePwdBtn" class="btn">ƒê·ªïi m·∫≠t kh·∫©u</button>
                <button id="resetAllBtn" class="btn ghost">Reset t·∫•t c·∫£ c√†i ƒë·∫∑t</button>
              </div>
            </div>
          </div>

        </div>

        <div class="right">
          <div class="card">
            <div class="small">Th√¥ng tin ng∆∞·ªùi d√πng</div>
            <div id="infoName" style="font-weight:700">‚Äî</div>
            <div class="small" id="infoBio">‚Äî</div>
            <div style="margin-top:8px" class="small" id="infoEmail">‚Äî</div>
          </div>

          <div class="card">
            <div class="small">Quick actions</div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="quickSaveCloud" class="btn">L∆∞u & Upload</button>
              <button id="quickResetLocal" class="btn ghost">Reset local</button>
            </div>
          </div>

          <div class="card">
            <div class="small">Tr·ª£ gi√∫p</div>
            <div class="small" style="margin-top:8px">Mu·ªën ƒë·ªìng b·ªô l√™n cloud tr∆∞·ªõc khi ƒëƒÉng xu·∫•t? Nh·∫•n "L∆∞u & Upload".</div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <!-- Toast container -->
  <div class="toast-wrap" id="toastWrap"></div>

  <!-- tiny base64 pop sound (silent fallback) -->
  <audio id="popSound" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAIlYAAESsAAACABAAZGF0YQAAAAA="></audio>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyC_8Y5vYXvXc0kvYH0jNOziiR0t1TtStTg",
  authDomain: "myproject-7ba9f.firebaseapp.com",
  projectId: "myproject-7ba9f",
  storageBucket: "myproject-7ba9f.appspot.com",
  messagingSenderId: "614709937741",
  appId: "1:614709937741:web:d11e5325162c249cfdfe04",
  measurementId: "G-LB9VZG4BHB"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ================= ELEMENTS ================= */
const tabs = document.querySelectorAll('.tab-btn');
const contents = document.querySelectorAll('.tab-content');
const toastWrap = document.getElementById('toastWrap');
const popSound = document.getElementById('popSound');

const miniAvatar = document.getElementById('miniAvatar');
const miniEmail = document.getElementById('miniEmail');
const topStatus = document.getElementById('topStatus');

const avatarInput = document.getElementById('avatarInput');
const avatarPreview = document.getElementById('avatarPreview');
const displayNameInput = document.getElementById('displayName');
const bioInput = document.getElementById('bio');
const saveProfileBtn = document.getElementById('saveProfileBtn');
const clearProfileBtn = document.getElementById('clearProfileBtn');

const themeMode = document.getElementById('themeMode');
const themeColor = document.getElementById('themeColor');
const saveThemeBtn = document.getElementById('saveThemeBtn');
const resetThemeBtn = document.getElementById('resetThemeBtn');

const defaultLevel = document.getElementById('defaultLevel');
const soundToggle = document.getElementById('soundToggle');
const effectToggle = document.getElementById('effectToggle');
const saveGameBtn = document.getElementById('saveGameBtn');
const resetGameBtn = document.getElementById('resetGameBtn');

const uploadCloudBtn = document.getElementById('uploadCloudBtn');
const downloadCloudBtn = document.getElementById('downloadCloudBtn');
const deleteCloudBtn = document.getElementById('deleteCloudBtn');
const cloudStatus = document.getElementById('cloudStatus');

const badgesWrap = document.getElementById('badgesWrap');
const logoutBtn = document.getElementById('logoutBtn');
const deleteAccountBtn = document.getElementById('deleteAccountBtn');
const changePwdBtn = document.getElementById('changePwdBtn');
const resetAllBtn = document.getElementById('resetAllBtn');
const quickSaveCloud = document.getElementById('quickSaveCloud');
const quickResetLocal = document.getElementById('quickResetLocal');

const infoName = document.getElementById('infoName');
const infoBio = document.getElementById('infoBio');
const infoEmail = document.getElementById('infoEmail');
const userEmailDisplay = document.getElementById('userEmailDisplay');

/* ================= CONSTANTS ================= */
const LS = { PROFILE: 'hv_profile_v2', THEME: 'hv_theme_v2', GAME: 'hv_game_v2' };
const AVATAR_MAX = 2 * 1024 * 1024; // 2MB

/* ================= TOAST ================= */
function toast(message, type='success', timeout=3000) {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.innerHTML = `<small>${message}</small>`;
  toastWrap.prepend(el);
  try { popSound.currentTime = 0; popSound.play().catch(()=>{}); } catch(e){}
  requestAnimationFrame(()=>el.classList.add('show'));
  setTimeout(()=>{ el.classList.remove('show'); setTimeout(()=>el.remove(),350); }, timeout);
}

/* ================= TABS ================= */
tabs.forEach(btn=>{
  btn.addEventListener('click',()=>{
    tabs.forEach(b=>b.classList.remove('active'));
    contents.forEach(c=>c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
  });
});

/* ================= AVATAR HANDLER ================= */
function fileToBase64(file){
  return new Promise((res,rej)=>{
    const fr = new FileReader();
    fr.onload=()=>res(fr.result);
    fr.onerror=rej;
    fr.readAsDataURL(file);
  });
}

avatarInput.addEventListener('change', async e=>{
  const f = e.target.files[0];
  if(!f) return;
  if(f.size > AVATAR_MAX) return toast('·∫¢nh qu√° l·ªõn (>2MB)!', 'error');
  const b64 = await fileToBase64(f);
  avatarPreview.src = miniAvatar.src = b64;
  avatarPreview.dataset.base64 = b64;
  saveProfileLocal();
});

/* ================= SAVE/LOAD LOCAL ================= */
function saveProfileLocal(){
  const obj = { name: displayNameInput.value, bio: bioInput.value, avatar: avatarPreview.dataset.base64||'' };
  localStorage.setItem(LS.PROFILE, JSON.stringify(obj));
  infoName.textContent = obj.name || '‚Äî';
  infoBio.textContent = obj.bio || '‚Äî';
  toast('ƒê√£ l∆∞u h·ªì s∆°', 'success');
}

function loadProfileLocal(){
  const raw = localStorage.getItem(LS.PROFILE);
  if(!raw) return;
  try {
    const p = JSON.parse(raw);
    displayNameInput.value = p.name||'';
    bioInput.value = p.bio||'';
    if(p.avatar) avatarPreview.src = miniAvatar.src = p.avatar;
    infoName.textContent = p.name || '‚Äî';
    infoBio.textContent = p.bio || '‚Äî';
  } catch(e){}
}

function saveThemeLocal(){
  const obj = { mode: themeMode.value, color: themeColor.value };
  localStorage.setItem(LS.THEME, JSON.stringify(obj));
  applyTheme(obj);
  toast('ƒê√£ l∆∞u giao di·ªán', 'success');
}
function loadThemeLocal(){
  const raw = localStorage.getItem(LS.THEME);
  if(!raw) return;
  const t = JSON.parse(raw);
  themeMode.value = t.mode;
  themeColor.value = t.color;
  applyTheme(t);
}

function saveGameLocal(){
  const obj = { level: defaultLevel.value, sound: soundToggle.checked, effect: effectToggle.checked };
  localStorage.setItem(LS.GAME, JSON.stringify(obj));
  toast('ƒê√£ l∆∞u c√†i ƒë·∫∑t tr√≤ ch∆°i', 'success');
}
function loadGameLocal(){
  const raw = localStorage.getItem(LS.GAME);
  if(!raw) return;
  const g = JSON.parse(raw);
  defaultLevel.value = g.level;
  soundToggle.checked = g.sound;
  effectToggle.checked = g.effect;
}

/* ================= THEME ================= */
function applyTheme(t){
  const mode = t.mode || 'dark';
  const color = t.color || '#ff6b35';
  document.documentElement.style.setProperty('--primary', color);
  document.documentElement.style.setProperty('--accent', shadeColor(color,40));
  document.body.style.background = mode === 'light' ? '#f7f8fb' : 'linear-gradient(180deg,#07101a,#0b1220)';
  document.documentElement.style.setProperty('--primary', '#ff6b35');
  document.documentElement.style.setProperty('--accent', '#ffd6a5');
  document.body.style.color = mode === 'light' ? '#07101a' : 'var(--text)';
}
function shadeColor(hex, percent){
  const f=parseInt(hex.slice(1),16),t=percent<0?0:255,p=Math.abs(percent)/100;
  const R=f>>16,G=f>>8&0x00FF,B=f&0x0000FF;
  const newR=Math.round((t-R)*p)+R,newG=Math.round((t-G)*p)+G,newB=Math.round((t-B)*p)+B;
  return "#"+(0x1000000+(newR<<16)+(newG<<8)+newB).toString(16).slice(1);
}

/* ================= CLOUD SYNC ================= */
let currentUser = null;

async function uploadToCloud(){
  if(!currentUser) return toast('C·∫ßn ƒëƒÉng nh·∫≠p','warn');
  const payload = {
    profile: JSON.parse(localStorage.getItem(LS.PROFILE)||'{}'),
    theme: JSON.parse(localStorage.getItem(LS.THEME)||'{}'),
    game: JSON.parse(localStorage.getItem(LS.GAME)||'{}'),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  await db.collection('users').doc(currentUser.uid).collection('meta').doc('settings').set(payload);
  toast('Upload th√†nh c√¥ng','success');
}

async function restoreFromCloud(){
  if(!currentUser) return toast('C·∫ßn ƒëƒÉng nh·∫≠p','warn');
  const ref = db.collection('users').doc(currentUser.uid).collection('meta').doc('settings');
  const snap = await ref.get();
  if(!snap.exists) return toast('Kh√¥ng c√≥ d·ªØ li·ªáu','warn');
  const data = snap.data();
  if(data.profile) localStorage.setItem(LS.PROFILE, JSON.stringify(data.profile));
  if(data.theme) localStorage.setItem(LS.THEME, JSON.stringify(data.theme));
  if(data.game) localStorage.setItem(LS.GAME, JSON.stringify(data.game));
  loadProfileLocal(); loadThemeLocal(); loadGameLocal();
  toast('Restore th√†nh c√¥ng','success');
}

/* ================= ACCOUNT ================= */
logoutBtn.addEventListener('click', ()=>{
  auth.signOut().then(()=>{
    toast('ƒê√£ ƒëƒÉng xu·∫•t','success');
    setTimeout(()=>window.location.href='../../loginNregister/login.html',800);
  }).catch(e=>toast(e.message,'error'));
});

deleteAccountBtn.addEventListener('click', async ()=>{
  if(!currentUser) return toast('Ch∆∞a ƒëƒÉng nh·∫≠p','warn');
  if(!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a t√†i kho·∫£n?')) return;
  await db.collection('users').doc(currentUser.uid).delete().catch(()=>{});
  await currentUser.delete().catch(()=>{});
  toast('ƒê√£ x√≥a t√†i kho·∫£n','success');
  setTimeout(()=>location.href='../../loginNregister/login.html',800);
});

changePwdBtn.addEventListener('click', ()=>{
  if(!currentUser) return toast('Ch∆∞a ƒëƒÉng nh·∫≠p','warn');
  auth.sendPasswordResetEmail(currentUser.email).then(()=>toast('ƒê√£ g·ª≠i email ƒë·ªïi m·∫≠t kh·∫©u','success'));
});

resetAllBtn.addEventListener('click', ()=>{
  if(confirm('Reset t·∫•t c·∫£ c√†i ƒë·∫∑t?')){
    localStorage.clear();
    toast('ƒê√£ reset to√†n b·ªô','success');
    setTimeout(()=>location.reload(),700);
  }
});

/* ================= QUICK ================= */
quickSaveCloud.addEventListener('click',()=>{ saveProfileLocal(); saveThemeLocal(); saveGameLocal(); uploadToCloud(); });
quickResetLocal.addEventListener('click',()=>{ localStorage.clear(); toast('Reset local','success'); setTimeout(()=>location.reload(),700); });

/* ================= AUTH STATE ================= */
auth.onAuthStateChanged(async u=>{
  currentUser = u;
  if(!u){
    topStatus.textContent = 'Ch∆∞a ƒëƒÉng nh·∫≠p';
    miniEmail.textContent = '‚Äî';
    loadProfileLocal(); loadThemeLocal(); loadGameLocal();
  } else {
    topStatus.textContent = `Xin ch√†o, ${u.displayName || u.email}`;
    miniEmail.textContent = u.email;
    userEmailDisplay.textContent = u.email;
    loadProfileLocal(); loadThemeLocal(); loadGameLocal();
  }
});

/* ================= INIT ================= */
loadProfileLocal(); loadThemeLocal(); loadGameLocal();

/* fix first sound interaction */
document.addEventListener('click',()=>{try{popSound.play().then(()=>popSound.pause(),()=>{});}catch(e){}},{once:true});
// theme-toggle.js
function setTheme(mode){
  const root = document.documentElement;
  if(mode === 'light'){
    root.style.setProperty('--bg-dark', '#f7f8fb');
    root.style.setProperty('--card', '#ffffff');
    root.style.setProperty('--text', '#1e293b');
    root.style.setProperty('--muted', '#64748b');
    document.body.style.background = '#f7f8fb';
    document.body.style.color = '#1e293b';
  } else {
    root.style.setProperty('--bg-dark', '#0f1724');
    root.style.setProperty('--card', 'rgba(255,255,255,0.03)');
    root.style.setProperty('--text', '#e6eef8');
    root.style.setProperty('--muted', '#9aa7bf');
    document.body.style.background = 'linear-gradient(180deg,#07101a,#0b1220)';
    document.body.style.color = '#e6eef8';
  }
  localStorage.setItem('hv_theme_mode', mode);
}

function loadTheme(){
  const saved = localStorage.getItem('hv_theme_mode') || 'dark';
  setTheme(saved);
}

document.addEventListener('DOMContentLoaded', ()=>{
  loadTheme();
});
// Light mode switch
const themeModeSelect = document.getElementById('themeMode');
themeModeSelect.addEventListener('change', ()=>{
  const mode = themeModeSelect.value;
  setTheme(mode);
});
themeMode.addEventListener("change", () => {
  toggleTheme(themeMode.value);
});

</script>
<script src="../../../js/theme_toggle.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="../../../js/setting_nav.js"></script>
</body>
</html>
