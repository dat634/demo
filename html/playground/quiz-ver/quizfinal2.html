<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>English Quiz - H·ªçcVui</title>
<style>
body{
  font-family:'Inter',sans-serif;
  margin:0;padding:0;
  display:flex;flex-direction:column;align-items:center;
  min-height:100vh;background:linear-gradient(180deg, #161616, #242424);
  justify-content: center;
}
#container{
  max-width:900px;min-height: 400px;width:900px;
  background:white;border-radius:10px;
  box-shadow:0 2px 10px rgba(0,0,0,0.1);
  display:flex;flex-direction:column;
}
#question{font-size:1.3em;font-weight:700;margin-bottom:16px;margin-top: 20px; text-align:center;}
#options{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:10px;margin: 10px 10px 10px 10px
}
.option{
  padding:12px;border:1px solid #ccc;border-radius:8px;
  cursor:pointer;transition:0.25s;background:white;text-align:left;
  display:flex;align-items:center;
}
.option div:first-child{font-weight:700;margin-right:8px;}
.option.selected{border-color:#007BFF;background:#e0f0ff;}
.option.correct{border-color:#28a745;background:#c8f7c5;}
.option.wrong{border-color:#dc3545;background:#f7c5c5;}
#controls{display:flex;justify-content:flex-end;gap:10px;margin-bottom:10px;}
button{padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:600;transition:0.3s;}
#btnConfirm{background:#007BFF;color:white;}
#btnSkip{background:#6c757d;color:white;}
#progress{font-size:0.9em;color:#555;margin-bottom:10px;text-align:center;}
#toast{
  position:fixed;bottom:20px;left:50%;transform:translateX(-50%);
  background:#333;color:white;padding:12px 20px;border-radius:6px;
  opacity:0;pointer-events:none;transition:0.3s;z-index:1000;
}
#toast.show{opacity:1;}
@media(max-width:500px){#options{grid-template-columns:1fr;}}
</style>
</head>
<body>
    <div id="navbar"></div>
<div id="container">
    <div>
        <div id="question">Loading question...  </div>
        <div id="options"></div>
        <div id="controls">
            <button id="btnSkip">B·ªè qua         </button>
            <button id="btnConfirm">X√°c nh·∫≠n    </button>
        </div>
        <div id="progress"></div>
    </div>
</div>
<div id="toast"></div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyC_8Y5vYXvXc0kvYH0jNOziiR0t1TtStTg",
  authDomain: "myproject-7ba9f.firebaseapp.com",
  projectId: "myproject-7ba9f",
  storageBucket: "myproject-7ba9f.firebasestorage.app",
  messagingSenderId: "614709937741",
  appId: "1:614709937741:web:d11e5325162c249cfdfe04",
  measurementId: "G-LB9VZG4BHB"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const qEl = document.getElementById("question");
const optsWrap = document.getElementById("options");
const btnConfirm = document.getElementById("btnConfirm");
const btnSkip = document.getElementById("btnSkip");
const progress = document.getElementById("progress");
const toast = document.getElementById("toast");

let vocabList = [], current = null, selected = null, index = 0;
let canNext = false;

function showToast(msg,ms=1100){
  toast.textContent = msg;
  toast.classList.add("show");
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>toast.classList.remove("show"), ms);
}
function shuffle(arr){return arr.map(v=>({v, r:Math.random()})).sort((a,b)=>a.r-b.r).map(x=>x.v);}

async function loadData(){
  try {
    const snap = await db.collection("vocabularies").get();
    vocabList = snap.docs
      .map(d=>d.data())
      .filter(v=>v.en && typeof v.vi==="string" && v.vi.trim().length>0);
    if(vocabList.length < 4){
      qEl.textContent = "‚ùóKh√¥ng ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ t·∫°o quiz.";
      return;
    }
    vocabList = shuffle(vocabList);
    index = 0;
    renderQuestion();
  } catch(e){
    console.error(e);
    qEl.textContent = "‚ùå L·ªói t·∫£i d·ªØ li·ªáu Firebase";
  }
}

function renderQuestion(){
  selected = null; canNext = false;
  current = vocabList[index % vocabList.length];
  if(!current || !current.vi){ index++; return renderQuestion(); }

  const wrongs = shuffle(vocabList.filter(v => v.en !== current.en && v.vi !== current.vi)).slice(0,3);
  const answers = shuffle([{ text: current.vi, correct: true }, ...wrongs.map(w => ({ text: w.vi, correct: false }))]);

  console.log("üß© Q:", current.en, "| ‚úÖ", current.vi);
  console.log("‚û°Ô∏è", answers.map(a=>`${a.text} (${a.correct})`));

  qEl.innerHTML = `What is the meaning of "<b>${current.en}</b>"?<br>
  <small style="color:#666;">Level: ${current.level||"?"} | Topic: ${current.topic||"?"}</small>`;

  optsWrap.innerHTML = "";
  answers.forEach((ans,i)=>{
    const div = document.createElement("div");
    div.className = "option";
    div.dataset.correct = ans.correct ? "true" : "false";
    div.innerHTML = `<div>${String.fromCharCode(65+i)}.</div><div>${ans.text}</div>`;
    div.onclick = ()=>selectOption(div);
    optsWrap.appendChild(div);
  });
  progress.textContent = `C√¢u ${index+1}/${vocabList.length}`;
}

function selectOption(el){
  if(canNext) return;
  document.querySelectorAll('.option').forEach(o=>o.classList.remove('selected'));
  el.classList.add('selected');
  selected = el;
}

function handleConfirm(){
  if(!selected){showToast("Ch∆∞a ch·ªçn ƒë√°p √°n");return;}
  const isCorrect = selected.dataset.correct === "true";

  console.log("üîπ English:", current.en);
  console.log("üîπ Correct:", current.vi);
  console.log("üîπ Selected:", selected.querySelector("div:nth-child(2)").textContent.trim());
  console.log("üîπ Match:", isCorrect);

  if(!canNext){
    if(isCorrect){
      selected.classList.add("correct");
      canNext = true;
      showToast("‚úÖ Ch√≠nh x√°c! Nh·∫•n Enter l·∫ßn n·ªØa ƒë·ªÉ qua c√¢u");
    } else {
      selected.classList.add("wrong");
      showToast("‚ùå Sai r·ªìi, ch·ªçn l·∫°i!");
      setTimeout(()=>{
        selected.classList.remove("wrong");
        selected.classList.remove("selected");
        selected = null;
      },600);
    }
  } else {
    index++;
    if(index >= vocabList.length){ vocabList = shuffle(vocabList); index = 0; }
    renderQuestion();
  }
}

function handleSkip(){
  index++;
  if(index >= vocabList.length){ vocabList = shuffle(vocabList); index = 0; }
  renderQuestion();
}

document.addEventListener("keydown",(e)=>{
  if(e.key >= '1' && e.key <= '4'){
    const idx = Number(e.key) - 1;
    const opt = document.querySelectorAll(".option")[idx];
    if(opt) selectOption(opt);
  } else if(e.key === "Enter"){
    handleConfirm();
  }
});

btnConfirm.onclick = handleConfirm;
btnSkip.onclick = handleSkip;
loadData();
</script>
<script src="../../../js/setting_nav.js"></script>
</body>
</html>
