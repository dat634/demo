<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HọcVui — Flashcard (Menu → Study → Test)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --dark:#0f1724; --accent:#ff6b35; --accent2:#ffd6a5; --muted:#6b7280; --bg:#0b1220;
  --card:#0f1724; --card-2:#0f1724; --light:#fffaf5;
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  color-scheme: dark;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#07101a,#0b1220);color:#e6eef8}
.header{width:100%;position:fixed;top:0;left:0;right:0;height:64px;display:flex;align-items:center;justify-content:space-between;padding:12px 20px;z-index:90;background:rgba(2,6,23,0.6);backdrop-filter:blur(6px);border-bottom:1px solid rgba(255,255,255,0.03)}
.brand{font-weight:800;color:var(--accent);font-size:20px}
.nav{display:flex;gap:16px;align-items:center;color:var(--muted)}

/* container */
.container{width:100%;max-width:1100px;padding:96px 20px 48px;margin:0 auto;display:flex;flex-direction:column;gap:18px;align-items:center}

/* panels */
.panel{width:100%;background:rgba(255,255,255,0.02);border-radius:12px;padding:18px;box-shadow:0 10px 40px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
.controls{display:flex;gap:10px;align-items:center}
.select{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--muted)}

/* menu */
.menu{width:100%;display:flex;flex-direction:column;align-items:center;gap:12px;text-align:center}
.menu h1{font-size:28px;color:var(--accent);margin:6px 0}

/* stage */
.stage{width:100%;min-height:520px;display:flex;align-items:center;justify-content:center;position:relative;transition:opacity .45s, transform .45s}
.hidden{display:none;opacity:0;transform:translateY(12px)}

/* card */
.card{width:420px;height:520px;perspective:1200px}
.card-inner{width:100%;height:100%;position:relative;border-radius:16px;transform-style:preserve-3d;transition:transform .7s cubic-bezier(.2,.8,.2,1)}
.card.flipped .card-inner{transform:rotateY(180deg)}
.face{position:absolute;inset:0;border-radius:16px;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:24px;backface-visibility:hidden;box-shadow:0 18px 40px rgba(2,6,23,0.6)}
.front{background:linear-gradient(180deg,#071425,#0b2230);border:1px solid rgba(255,255,255,0.03)}
.back{transform:rotateY(180deg);background:linear-gradient(180deg,#fff7ef,#fff2e6);color:#07101a}

/* text */
.word{font-size:40px;font-weight:800;text-align:center}
.meaning{font-size:18px;color:var(--muted);text-align:center;margin-top:12px}

/* controls */
.card-controls{display:flex;gap:10px;justify-content:center;margin-top:12px;align-items:center}
.btn{background:linear-gradient(90deg,var(--accent),var(--accent2));border:none;padding:10px 12px;border-radius:10px;color:#07101a;font-weight:800;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}

/* test UI */
.test-area{width:100%;max-width:880px;display:flex;flex-direction:column;gap:12px;align-items:center}
.question-card{width:100%;background:rgba(255,255,255,0.02);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
.q-text{font-size:18px;font-weight:700;text-align:center}
.options{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
.opt{padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.03);cursor:pointer;font-weight:700;text-align:center}
.opt.disabled{opacity:0.5;pointer-events:none}

/* fill */
.input-row{display:flex;gap:10px;margin-top:12px}
.input-row input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.18);color:inherit}

/* meta */
.meta{width:100%;max-width:880px;display:flex;justify-content:space-between;align-items:center;gap:12px}
.progress{flex:1;height:8px;background:rgba(255,255,255,0.03);border-radius:999px;overflow:hidden;margin-right:12px}
.progress-bar{height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .35s linear}
.timer{min-width:120px;text-align:right;color:var(--muted)}

/* summary */
.summary-overlay{position:fixed;left:0;right:0;top:0;bottom:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.6);z-index:120}
.summary-overlay.show{display:flex}
.summary-card{width:100%;max-width:720px;background:linear-gradient(180deg,#07101a,#0b1724);padding:20px;border-radius:12px;text-align:center;box-shadow:0 12px 40px rgba(0,0,0,0.6);color:var(--muted)}
.summary-title{font-weight:800;font-size:20px;color:var(--accent2)}

/* responsive */
@media(max-width:820px){
  .card{width:88vw;height:62vh}
  .options{grid-template-columns:1fr}
}
.small{
  font-size:14px;
  text-decoration: none;
  color: var(--muted);
    height: 19px;
  width: 70px;
  text-align: center;
  border-left: 1px solid transparent;
  border-right: 1px solid transparent;
  transition: all 0.3s ease;
}
.small:hover{
  color: var(--accent);
  border-left: 1px solid var(--muted);
  border-right: 1px solid var(--muted);
  border-radius: -5px;
  height: 19px;
  transition: all 0.3s ease;
}
</style>
</head>
<body>
  <div class="header">
    <div class="brand">Học<span style="background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent">Vui</span></div>
    <div class="nav">
      <div class="small" id="userName">—</div>
      <a class="small" href="#">Study</a>
      <a class="small" href="#">Game</a>
      <a class="small" href="#">Advance</a>
      <a class="small" href="#">Setting</a>
    </div>
  </div>

  <div class="container">

    <!-- MENU -->
    <div id="menuStage" class="panel menu">
      <h1>Chọn Level & Bắt đầu</h1>
      <div class="controls">
        <label class="small" style="color:var(--muted);margin-right:8px">Level:</label>
        <select id="levelSelect" class="select">
          <option value="all">All</option>
          <option value="A1">A1</option><option value="A2">A2</option>
          <option value="B1">B1</option><option value="B2">B2</option>
          <option value="C1">C1</option><option value="C2">C2</option>
        </select>
        <button id="startBtn" class="btn">Start</button>
      </div>
      <p class="small1" style="max-width:760px;color:var(--muted)">Chọn cấp độ muốn học — trang sẽ load 19 từ để học, sau đó tự chuyển sang phần kiểm tra gồm 10 trắc nghiệm và 5 câu điền từ.</p>
    </div>

    <!-- STUDY -->
    <div id="studyStage" class="stage hidden panel">
      <div style="display:flex;flex-direction:column;align-items:center;gap:10px">
        <div class="card" id="card">
          <div class="card-inner" id="cardInner">
            <div class="face front">
              <div class="word" id="frontWord">...</div>
              <div class="meaning small" id="frontHint">(Nhấn để lật)</div>
            </div>
            <div class="face back">
              <div class="word" id="backWord">...</div>
              <div class="meaning" id="backMeaning">...</div>
            </div>
          </div>
        </div>
        <div class="card-controls">
          <button id="flipBtn" class="btn">Flip</button>
          <button id="nextBtn" class="btn ghost">Next »</button>
          <div class="small">Score: <span id="scoreDisplay">0</span></div>
        </div>
      </div>
    </div>

    <!-- TEST -->
    <div id="testStage" class="stage hidden panel">
      <div class="test-area">
        <div class="question-card" id="questionCard">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="q-text" id="questionText">Question</div>
            <div class="timer small" id="timerDisplay">25:00</div>
          </div>
          <div id="optionsWrap" class="options" style="margin-top:12px"></div>
          <div id="fillWrap" style="display:none;margin-top:12px">
            <div class="small" style="text-align:center;margin-bottom:8px">Nhập từ tiếng Anh:</div>
            <div class="input-row">
              <input id="fillInput" placeholder="Type English..." />
              <button id="submitFill" class="btn">Gửi</button>
              <button id="skipBtn" class="btn ghost">Bỏ qua (-2)</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div style="width:100%;max-width:880px;display:flex;flex-direction:column;gap:10px;align-items:center;margin-top:8px">
      <div class="meta">
        <div class="progress"><div id="progressBar" class="progress-bar"></div></div>
        <div class="small" id="posInfo">0 / 19</div>
      </div>
    </div>

  </div>

  <!-- summary overlay -->
  <div class="summary-overlay" id="summaryOverlay" aria-hidden="true">
    <div class="summary-card">
      <div class="summary-title" id="summaryTitle">KẾT QUẢ</div>
      <div style="margin-top:12px;color:#fff">Tổng điểm: <strong id="summaryScore">0</strong></div>
      <div style="margin-top:8px" class="small" id="summaryText">—</div>
      <div style="display:flex;gap:10px;justify-content:center;margin-top:12px">
        <button id="btnRetry" class="btn">Kiểm tra lại</button>
        <button id="btnHome" class="btn ghost">Về màn hình chính</button>
      </div>
    </div>
  </div>

  <!-- firebase scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<script>
// === Firebase Config ===
const firebaseConfig = {
  apiKey: "AIzaSyC_8Y5vYXvXc0kvYH0jNOziiR0t1TtStTg",
  authDomain: "myproject-7ba9f.firebaseapp.com",
  projectId: "myproject-7ba9f",
  storageBucket: "myproject-7ba9f.appspot.com",
  messagingSenderId: "614709937741",
  appId: "1:614709937741:web:d11e5325162c249cfdfe04",
  measurementId: "G-LB9VZG4BHB"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// === State ===
let vocab = [], studyPool = [], studyIndex = 0, testQueue = [], testIndex = 0;
let score = 0, timerSeconds = 25 * 60, timerInterval = null;

// === DOM ===
const menuStage = document.getElementById('menuStage');
const studyStage = document.getElementById('studyStage');
const testStage = document.getElementById('testStage');
const levelSelect = document.getElementById('levelSelect');
const startBtn = document.getElementById('startBtn');
const card = document.getElementById('card');
const frontWord = document.getElementById('frontWord');
const backWord = document.getElementById('backWord');
const backMeaning = document.getElementById('backMeaning');
const flipBtn = document.getElementById('flipBtn');
const nextBtn = document.getElementById('nextBtn');
const scoreDisplay = document.getElementById('scoreDisplay');
const progressBar = document.getElementById('progressBar');
const summaryOverlay = document.getElementById('summaryOverlay');
const summaryScore = document.getElementById('summaryScore');
const summaryTitle = document.getElementById('summaryTitle');
const summaryText = document.getElementById('summaryText');
const btnRetry = document.getElementById('btnRetry');
const btnHome = document.getElementById('btnHome');

// === Helper ===
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
function pickN(arr,n){ return shuffle(arr.slice()).slice(0,Math.min(n,arr.length)); }
function setProgress(frac){ progressBar.style.width = `${Math.round(frac*100)}%`; }
function updateScore(){ scoreDisplay.textContent = score; }

// === Audio ===
const AudioSynth = (() => {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  function tone(f, d, t='sine', g=0.05){
    const o = ctx.createOscillator(); const gn = ctx.createGain();
    o.type = t; o.frequency.value = f; gn.gain.value = g;
    o.connect(gn); gn.connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime + d);
  }
  return {
    click(){ tone(880,0.05); },
    correct(){ tone(1320,0.12); tone(990,0.08); },
    wrong(){ tone(220,0.12,'square'); },
    finish(){ tone(1760,0.15); tone(1320,0.1); }
  };
})();

// === Load vocab ===
auth.onAuthStateChanged(async (u)=>{
  if(!u){ window.location.href = "../loginNregister/login.html"; return; }
  await loadVocab();
});

async function loadVocab(){
  try{
    const snap = await db.collection('vocabularies').get();
    vocab = snap.docs.map(d => ({ id:d.id, ...d.data() }));
  }catch(e){
    console.warn('Load error', e);
    vocab = [{en:'apple',vi:'quả táo',level:'A1'}];
  }
}

// === Study ===
startBtn.addEventListener('click', startStudy);
flipBtn.addEventListener('click', ()=>{ card.classList.toggle('flipped'); AudioSynth.click(); });
card.addEventListener('click', (e)=>{ if(e.target.tagName.toLowerCase()!=='button'){ card.classList.toggle('flipped'); AudioSynth.click(); }});
nextBtn.addEventListener('click', ()=>{
  studyIndex++;
  if(studyIndex >= studyPool.length){ transitionToTest(); return; }
  showStudyCard(studyIndex);
});

function startStudy(){
  const lvl = levelSelect.value;
  let candidates = (lvl==='all') ? vocab : vocab.filter(w => w.level === lvl);
  if(!candidates.length){ alert('Không có từ cho level này!'); return; }
  studyPool = pickN(candidates, 19);
  studyIndex = 0; score = 0;
  updateScore(); setProgress(0);
  menuStage.classList.add('hidden');
  studyStage.classList.remove('hidden');
  showStudyCard(0);
}

function showStudyCard(i){
  const w = studyPool[i];
  frontWord.textContent = w.en || '...';
  backWord.textContent = w.en || '...';
  backMeaning.textContent = w.vi || '...';
  card.classList.remove('flipped');
  setProgress(i/studyPool.length);
}

// === Transition ===
function transitionToTest(){
  studyStage.style.opacity = 0;
  studyStage.style.transform = 'translateY(15px)';
  setTimeout(()=>{
    studyStage.classList.add('hidden');
    prepareTest();
    showTestStage();
  },400);
}

// === Test logic (10 MC + 5 Fill + 4 TF) ===
let testTimer;
const questionText = document.getElementById('questionText');
const optionsWrap = document.getElementById('optionsWrap');
const fillWrap = document.getElementById('fillWrap');
const fillInput = document.getElementById('fillInput');
const submitFill = document.getElementById('submitFill');
const skipBtn = document.getElementById('skipBtn');
const timerDisplay = document.getElementById('timerDisplay');

function prepareTest(){
  studyPool = shuffle(studyPool);
  const mcCount = 10, fillCount = 5, tfCount = 4;
  testQueue = [];
  for(let i=0;i<mcCount;i++) testQueue.push({type:'mc', idx:i});
  for(let j=0;j<fillCount;j++) testQueue.push({type:'fill', idx:mcCount+j});
  for(let k=0;k<tfCount;k++) testQueue.push({type:'tf', idx:(mcCount+fillCount+k)%studyPool.length});
  shuffle(testQueue);
  testIndex = 0;
}

function showTestStage(){
  testStage.classList.remove('hidden');
  testStage.style.opacity = 1;
  startTimer();
  showTestItem(0);
}

function startTimer(){
  clearInterval(testTimer);
  timerSeconds = 25 * 60;
  updateTimer();
  testTimer = setInterval(()=>{
    timerSeconds--; updateTimer();
    if(timerSeconds<=0){ clearInterval(testTimer); endTest(); }
  },1000);
}
function updateTimer(){
  const m=Math.floor(timerSeconds/60), s=timerSeconds%60;
  timerDisplay.textContent=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function showTestItem(i){
  if(i >= testQueue.length){ endTest(); return; }
  testIndex = i;
  const item = testQueue[i], w = studyPool[item.idx];
  optionsWrap.innerHTML='';
  fillWrap.style.display='none';
  questionText.classList.remove('fade-slide');
  void questionText.offsetWidth;
  questionText.classList.add('fade-slide');
  setProgress(i/testQueue.length);

  if(item.type === 'mc'){
    const others = vocab.filter(v=>v.en !== w.en);
    const opts = shuffle([w, ...pickN(others,3)]);
    questionText.textContent = `Chọn nghĩa đúng cho: "${w.en}"`;
    opts.forEach(opt=>{
      const el=document.createElement('div');
      el.className='opt';
      el.textContent=opt.vi;
      el.onclick=()=>handleAnswer(opt.en===w.en);
      optionsWrap.appendChild(el);
    });
  }
  else if(item.type === 'fill'){
    questionText.textContent = `Viết từ tiếng Anh cho: "${w.vi}"`;
    fillWrap.style.display='block';
    submitFill.onclick = ()=>{
      const val = fillInput.value.trim().toLowerCase();
      handleAnswer(val === w.en.toLowerCase());
      fillInput.value='';
    };
    skipBtn.onclick = ()=>{ score -= 2; updateScore(); nextQuestion(); };
  }
  else if(item.type === 'tf'){
    // true/false random
    const isCorrect = Math.random() < 0.5;
    const shownVi = isCorrect ? w.vi : pickN(vocab.filter(v=>v.en!==w.en),1)[0].vi;
    questionText.textContent = `Từ "${w.en}" có nghĩa là "${shownVi}"?`;
    ['Đúng','Sai'].forEach(txt=>{
      const el=document.createElement('div');
      el.className='opt';
      el.textContent=txt;
      el.onclick=()=>handleAnswer((txt==='Đúng')===isCorrect);
      optionsWrap.appendChild(el);
    });
  }
}

function handleAnswer(correct){
  if(correct){ score += 10; AudioSynth.correct(); }
  else { score -= 5; AudioSynth.wrong(); }
  updateScore();
  setTimeout(nextQuestion, 400);
}
function nextQuestion(){ showTestItem(testIndex+1); }

function endTest(){
  clearInterval(testTimer);
  summaryOverlay.classList.add('show');
  summaryScore.textContent = score;
  summaryTitle.textContent = (score>=100)?"Phá vỡ mọi giới hạn.":(score>40)?"Continue your Streak !!!":"Hãy cố gắng hết sức nhé !!";
  summaryText.textContent = `Bạn đã hoàn thành. Tổng: ${score} điểm.`;
  AudioSynth.finish();
}

// === Summary buttons ===
btnRetry.onclick = ()=>{ summaryOverlay.classList.remove('show'); prepareTest(); showTestStage(); };
btnHome.onclick = ()=>{ location.reload(); };
</script>
</body>
</html>
