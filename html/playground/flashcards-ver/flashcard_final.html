<!doctype html>
<html lang="vi">
<head>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>H·ªçcVui ‚Äî Flashcard Final</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --dark:#0f1724; --accent:#ff6b35; --accent2:#ffd6a5; --muted:#6b7280; --bg:#fffaf5;
  --card:#ffffff; --shadow: 0 8px 28px rgba(2,6,23,0.08);
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#0b1220;min-height:100vh;display:flex;flex-direction:column;align-items:center;}
.header{width:100%;background:linear-gradient(90deg,#fff,#fff);box-shadow:0 1px 0 rgba(0,0,0,0.04);position:fixed;top:0;left:0;right:0;height:64px;display:flex;align-items:center;justify-content:space-between;padding:12px 20px;z-index:90}
.brand{font-weight:700;color:var(--accent);font-size:20px}
.nav{display:flex;gap:16px;align-items:center;color:var(--muted)}
.container{width:100%;max-width:1100px;padding:96px 20px 48px;display:flex;flex-direction:column;gap:14px;align-items:center}

/* main UI */
.panel{width:100%;background:var(--card);border-radius:12px;padding:18px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:12px}
.controls{display:flex;gap:10px;align-items:center}
.select{padding:8px 10px;border-radius:8px;border:1px solid rgba(15,23,36,0.06);background:#fff}
.btn{background:linear-gradient(90deg,var(--accent),var(--accent2));border:none;padding:10px 12px;border-radius:10px;color:#fff;font-weight:700;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid rgba(11,18,32,0.06);color:var(--muted)}

/* card */
.stage{width:100%;min-height:520px;display:flex;align-items:center;justify-content:center;position:relative}
.card{width:420px;height:520px;perspective:1200px}
.card-inner{width:100%;height:100%;position:relative;border-radius:12px;transform-style:preserve-3d;transition:transform .7s cubic-bezier(.2,.8,.2,1)}
.card.flipped .card-inner{transform:rotateY(180deg)}
.face{position:absolute;inset:0;border-radius:12px;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:24px;backface-visibility:hidden;box-shadow:0 10px 30px rgba(11,18,32,0.06)}
.front{background:linear-gradient(180deg,#fff,#fff);border:1px solid rgba(11,18,32,0.04)}
.back{transform:rotateY(180deg);background:linear-gradient(180deg,#fff7ef,#fff2e6);border:1px solid rgba(11,18,32,0.04)}

/* text */
.word{font-size:40px;font-weight:800;text-align:center}
.meaning{font-size:18px;color:var(--muted);text-align:center;margin-top:12px}

/* controls */
.card-controls{display:flex;gap:10px;justify-content:center;margin-top:12px;align-items:center}
.small{font-size:13px;color:var(--muted); text-decoration: none;}

/* test UI */
.test-area{width:100%;max-width:820px;display:flex;flex-direction:column;gap:12px;align-items:center}
.question-card{width:100%;background:#ffffff;padding:16px;border-radius:12px;border:1px solid rgba(11,18,32,0.04)}
.q-text{font-size:18px;font-weight:700;text-align:center}
.options{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
.opt{padding:12px;border-radius:10px;border:1px solid rgba(11,18,32,0.06);background:#fff;cursor:pointer;font-weight:600;text-align:center}
.opt.disabled{opacity:0.6;pointer-events:none}

/* fill input */
.input-row{display:flex;gap:10px;margin-top:12px}
.input-row input{flex:1;padding:10px;border-radius:10px;border:1px solid rgba(11,18,32,0.06)}

/* progress & timer */
.meta{width:100%;max-width:820px;display:flex;justify-content:space-between;align-items:center;gap:12px}
.progress{flex:1;height:8px;background:rgba(11,18,32,0.04);border-radius:999px;overflow:hidden;margin-right:12px}
.progress-bar{height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .35s linear}
.timer{min-width:120px;text-align:right;color:var(--muted)}

/* summary overlay */
.summary-overlay{position:fixed;left:0;right:0;top:0;bottom:0;display:none;align-items:center;justify-content:center;background:rgba(11,18,32,0.45);z-index:120}
.summary-overlay.show{display:flex}
.summary-card{width:100%;max-width:680px;background:#fff;padding:20px;border-radius:12px;text-align:center;box-shadow:var(--shadow)}
.summary-title{font-weight:800;font-size:20px;color:var(--accent)}

/* small responsive */
@media(max-width:820px){
  .card{width:88vw;height:62vh}
  .options{grid-template-columns:1fr}
}
</style>
</head>
<body>
  <div class="header">
    <div class="brand">H·ªçc<span style="background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent">Vui</span> üéì</div>
    <div class="nav">
      
      <a class="small" href="#" id="navStudy">Study</a>
      <a class="small" href="#" id="navGame">Game</a>
      <a class="small" href="#" id="navAdvance">Advance</a>
      <a class="small" href="#" id="navSetting">Setting</a>
      <p>|</p>
      <div class="small" id="userName"><p>-</p></div>
      <div class="small"><img src="/example/ex1.png" alt="avatar" width="20px";height="20px"></div>
    </div>
  </div>

  <div class="container">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="display:flex;align-items:center;gap:8px">
          <label class="small">Ch·ªçn level:</label>
          <select id="levelSelect" class="select">
            <option value="all">All</option>
            <option value="A1">A1</option><option value="A2">A2</option>
            <option value="B1">B1</option><option value="B2">B2</option>
            <option value="C1">C1</option><option value="C2">C2</option>
          </select>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="small">Mode: <span id="modeLabel">Study</span></div>
          <button id="playBtn" class="btn">Play</button>
        </div>
      </div>
    </div>

    <!-- Stage -->
    <div id="studyStage" class="stage">
      <div id="cardArea" style="display:flex;flex-direction:column;align-items:center;gap:10px">
        <div class="card" id="card">
          <div class="card-inner" id="cardInner">
            <div class="face front">
              <div class="word" id="frontWord">...</div>
              <div class="meaning small" id="frontHint">(Nh·∫•n ƒë·ªÉ l·∫≠t)</div>
            </div>
            <div class="face back">
              <div class="word" id="backWord">...</div>
              <div class="meaning" id="backMeaning">...</div>
            </div>
          </div>
        </div>
        <div class="card-controls">
          <button id="flipBtn" class="btn">Flip</button>
          <button id="nextBtn" class="btn ghost">Next ¬ª</button>
          <div class="small">Score: <span id="scoreDisplay">0</span></div>
        </div>
      </div>
    </div>

    <div id="testStage" class="stage" style="display:none;opacity:0;transform:translateY(12px)">
      <div class="test-area">
        <div class="question-card" id="questionCard">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="q-text" id="questionText">Question</div>
            <div class="timer small" id="timerDisplay">25:00</div>
          </div>
          <div id="optionsWrap" class="options" style="margin-top:12px"></div>
          <div id="fillWrap" style="display:none;margin-top:12px">
            <div class="small" style="text-align:center;margin-bottom:8px">Nh·∫≠p t·ª´ ti·∫øng Anh:</div>
            <div class="input-row">
              <input id="fillInput" placeholder="Type English..." />
              <button id="submitFill" class="btn">G·ª≠i</button>
              <button id="skipBtn" class="btn ghost">B·ªè qua (-2)</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div style="width:100%;max-width:820px;display:flex;flex-direction:column;gap:10px;align-items:center;margin-top:8px">
      <div class="meta">
        <div class="progress"><div id="progressBar" class="progress-bar"></div></div>
        <div class="small" id="posInfo">0 / 19</div>
      </div>
    </div>

  </div>

  <!-- summary overlay -->
  <div class="summary-overlay" id="summaryOverlay" aria-hidden="true">
    <div class="summary-card">
      <div class="summary-title" id="summaryTitle">K·∫æT QU·∫¢</div>
      <div style="margin-top:12px">T·ªïng ƒëi·ªÉm: <strong id="summaryScore">0</strong></div>
      <div style="margin-top:8px" class="small" id="summaryText">‚Äî</div>
      <div style="display:flex;gap:10px;justify-content:center;margin-top:12px">
        <button id="btnRetry" class="btn">Ki·ªÉm tra l·∫°i</button>
        <button id="btnHome" class="btn ghost">Trang ch√≠nh</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
 


<script>
// ==== Firebase config (integrated) ====
const firebaseConfig = {
  apiKey: "AIzaSyC_8Y5vYXvXc0kvYH0jNOziiR0t1TtStTg",
  authDomain: "myproject-7ba9f.firebaseapp.com",
  projectId: "myproject-7ba9f",
  storageBucket: "myproject-7ba9f.appspot.com",
  messagingSenderId: "614709937741",
  appId: "1:614709937741:web:d11e5325162c249cfdfe04",
  measurementId: "G-LB9VZG4BHB"
};
if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
(async () => {
  const snapshot = await db.collection("vocabularies").get();
  const vocabList = snapshot.docs.map(doc => doc.data());
  console.log("‚úÖ Loaded", vocabList.length, "words");
})();

// ==== State ====
let currentUser = null;
let vocab = [];
let studyPool = [];
let studyIndex = 0;
let testQueue = [];
let testIndex = 0;
let score = 0;
let timerSeconds = 25*60; // 25 minutes
let timerInterval = null;

// ==== DOM ====
const levelSelect = document.getElementById('levelSelect');
const playBtn = document.getElementById('playBtn');
const modeLabel = document.getElementById('modeLabel');
const card = document.getElementById('card');
const cardInner = document.getElementById('cardInner');
const frontWord = document.getElementById('frontWord');
const frontHint = document.getElementById('frontHint');
const backWord = document.getElementById('backWord');
const backMeaning = document.getElementById('backMeaning');
const flipBtn = document.getElementById('flipBtn');
const nextBtn = document.getElementById('nextBtn');
const scoreDisplay = document.getElementById('scoreDisplay');
const posInfo = document.getElementById('posInfo');
const progressBar = document.getElementById('progressBar');

const studyStage = document.getElementById('studyStage');
const testStage = document.getElementById('testStage');
const questionText = document.getElementById('questionText');
const optionsWrap = document.getElementById('optionsWrap');
const fillWrap = document.getElementById('fillWrap');
const fillInput = document.getElementById('fillInput');
const submitFill = document.getElementById('submitFill');
const skipBtn = document.getElementById('skipBtn');
const timerDisplay = document.getElementById('timerDisplay');

const summaryOverlay = document.getElementById('summaryOverlay');
const summaryScore = document.getElementById('summaryScore');
const summaryTitle = document.getElementById('summaryTitle');
const summaryText = document.getElementById('summaryText');
const btnRetry = document.getElementById('btnRetry');
const btnHome = document.getElementById('btnHome');
const userName = document.getElementById('userName');

// ==== sound using WebAudio (synthesized short tones) ====
const AudioSynth = (()=>{
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  function tone(freq,dur, type='sine', gain=0.05){
    const o = ctx.createOscillator(); const g = ctx.createGain();
    o.type = type; o.frequency.value = freq; g.gain.value = gain;
    o.connect(g); g.connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime + dur);
  }
  return {
    click(){ tone(880,0.06,'sine',0.03) },
    correct(){ tone(1320,0.12,'sine',0.06); tone(990,0.08,'sine',0.04) },
    wrong(){ tone(220,0.12,'square',0.06) },
    finish(){ tone(1760,0.16,'sine',0.06); tone(1320,0.12,'sine',0.05) }
  }
})();

// ==== helpers ====
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a }
function pickN(arr,n){ return shuffle(arr.slice()).slice(0,Math.min(n,arr.length)) }

// ==== Auth & load ====
auth.onAuthStateChanged(async (u)=>{
  if(!u){
    // redirect to login page if not authenticated
    window.location.href = "../loginNregister/login.html";
    return;
  }
  currentUser = u;
  userName.textContent = u.displayName || u.email || 'User';
  await loadVocab();
});

async function loadVocab(){
  try{
    const snap = await db.collection('vocabularies').get();
    vocab = snap.docs.map(d=> ({ id:d.id, ...d.data() })).filter(x=>x.en && x.vi && x.level);
    console.log('Loaded vocab:', vocab.length);
  }catch(e){
    console.warn('Load vocab failed', e);
    vocab = [{en:'apple',vi:'qu·∫£ t√°o',level:'A1'}];
  }
}

// ==== Study logic ====
playBtn.addEventListener('click', ()=> startStudy());

function startStudy(){
  const lvl = levelSelect.value;
  let candidates = (lvl==='all') ? vocab.slice() : vocab.filter(w=>w.level===lvl);
  if(candidates.length === 0){ alert('Kh√¥ng c√≥ t·ª´ cho level n√†y. Ch·ªçn All ho·∫∑c th√™m d·ªØ li·ªáu.'); return; }
  studyPool = pickN(candidates, 19);
  studyIndex = 0; score = 0; updateScore();
  modeLabel.textContent = 'Study';
  showStudyCard(studyIndex);
  studyStage.style.display = 'flex'; testStage.style.display='none';
  studyStage.style.opacity = 1; studyStage.style.transform='translateY(0)';
  attachStudyListeners();
  posInfo.textContent = `${studyIndex+1} / ${studyPool.length}`;
  setProgress(0);
  AudioSynth.click();
 
}

function showStudyCard(i){
  const w = studyPool[i];
  frontWord.textContent = w.en; backWord.textContent = w.en; backMeaning.textContent = w.vi;
  card.classList.remove('flipped');
  posInfo.textContent = `${i+1} / ${studyPool.length}`;
  setProgress(i/studyPool.length);
}

function attachStudyListeners(){
  // remove old clones to prevent multiple handlers
  replaceWithClone(flipBtn); replaceWithClone(nextBtn); replaceWithClone(card);
  const f = document.getElementById('flipBtn');
  const n = document.getElementById('nextBtn');
  const c = document.getElementById('card');
  f.addEventListener('click', (e)=>{ e.stopPropagation(); c.classList.toggle('flipped'); AudioSynth.click(); });
  n.addEventListener('click', (e)=>{ e.stopPropagation(); studyIndex++; if(studyIndex>=studyPool.length){ transitionToTest(); return;} showStudyCard(studyIndex); });
  c.addEventListener('click', (e)=>{ const path = e.composedPath ? e.composedPath() : (e.path||[]); for(const node of path){ if(!node||!node.tagName) continue; if(node.tagName.toLowerCase()==='button') return; } c.classList.toggle('flipped'); AudioSynth.click(); });
}

function replaceWithClone(el){ const cl = el.cloneNode(true); el.parentNode.replaceChild(cl,el); }

function updateScore(){ scoreDisplay.textContent = score; }

function setProgress(frac){ progressBar.style.width = `${Math.round(frac*100)}%`; }

// transition
function transitionToTest(){
  // fade out study
  studyStage.style.opacity = 0; studyStage.style.transform='translateY(12px)';
  setTimeout(()=>{
    studyStage.style.display='none';
    prepareTest();
    showTestStage();
  },420);
}

// ==== Test logic ====
function prepareTest(){
  // shuffle studyPool; pick 14 mc + 5 fill
  studyPool = shuffle(studyPool.slice());
  const total = studyPool.length;
  const mcCount = Math.min(14, Math.max(0, total-5));
  const fillCount = Math.min(5, total-mcCount);
  testQueue = [];
  for(let i=0;i<mcCount;i++) testQueue.push({type:'tf', idx:i});
  for(let j=0;j<fillCount;j++) testQueue.push({type:'fill', idx:mcCount+j});
  testIndex = 0; score = 0; updateScore();
}

function showTestStage(){
  modeLabel.textContent = 'Test';
  testStage.style.display='flex';
  setTimeout(()=>{ testStage.style.opacity=1; testStage.style.transform='translateY(0)'; },60);
  startTimer();
  showTestItem(0);
}

function startTimer(){
  clearInterval(timerInterval); timerSeconds = 25*60;
  updateTimerDisplay();
  timerInterval = setInterval(()=>{
    timerSeconds--; updateTimerDisplay();
    if(timerSeconds<=0){ clearInterval(timerInterval); onTimeUp(); }
  },1000);
}

function updateTimerDisplay(){
  const m = Math.floor(timerSeconds/60), s = timerSeconds%60;
  timerDisplay.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}

function onTimeUp(){
  AudioSynth.finish();
  endTest();
}

function showTestItem(i){
  clearTestUI();
  if(i>=testQueue.length){ endTest(); return; }
  testIndex = i;
  const item = testQueue[i];
  const w = studyPool[item.idx];
  posInfo.textContent = `${i+1} / ${testQueue.length}`;
  setProgress(i/testQueue.length);
  if(item.type === 'tf'){
    // 50% show real meaning, 50% swap meaning from other to create false
    let isFake = Math.random()<0.5 && vocab.length>1;
    let shownMeaning = w.vi; let correctAnswer = true;
    if(isFake){
      const others = vocab.filter(x=> x.en !== w.en); const fake = others[Math.floor(Math.random()*others.length)];
      if(fake){ shownMeaning = fake.vi; correctAnswer = false; }
    }
    questionText.textContent = `T·ª´: "${w.en}" ‚Üí √ù nghƒ©a: "${shownMeaning}" (ƒê√∫ng/Sai?)`;
    optionsWrap.innerHTML = '';
    const btnTrue = createOpt('ƒê√∫ng', '1'); const btnFalse = createOpt('Sai','0');
    btnTrue.addEventListener('click', ()=>{ onAnswer(correctAnswer); visualFeedback(btnTrue, correctAnswer); });
    btnFalse.addEventListener('click', ()=>{ onAnswer(!correctAnswer); visualFeedback(btnFalse, !correctAnswer); });
    optionsWrap.appendChild(btnTrue); optionsWrap.appendChild(btnFalse);
    optionsWrap.style.display='grid'; fillWrap.style.display='none';
  } else {
    questionText.textContent = `Vi·∫øt t·ª´ ti·∫øng Anh cho: "${w.vi}"`;
    optionsWrap.style.display='none'; fillWrap.style.display='block';
    replaceWithClone(submitFill); replaceWithClone(skipBtn);
    document.getElementById('submitFill').addEventListener('click', ()=>{
      const val = document.getElementById('fillInput').value.trim().toLowerCase();
      const ok = val === (w.en||'').toLowerCase();
      onAnswer(ok);
    });
    document.getElementById('skipBtn').addEventListener('click', ()=>{ onSkip(); });
  }
}

function createOpt(text, val){
  const d = document.createElement('div'); d.className='opt'; d.textContent = text; d.dataset.val=val;
  return d;
}

function visualFeedback(el, correct){
  if(correct){ el.style.background='rgba(16,185,129,0.12)'; el.style.borderColor='rgba(16,185,129,0.6)'; AudioSynth.correct(); }
  else { el.style.background='rgba(239,68,68,0.06)'; el.style.borderColor='rgba(239,68,68,0.6)'; AudioSynth.wrong(); }
  // disable siblings
  Array.from(optionsWrap.children).forEach(o=> o.classList.add('disabled'));
  setTimeout(()=>{ /* move next handled in onAnswer */ }, 300);
}

function onAnswer(correct){
  if(correct) score += 10; else score -= 5;
  updateScore();
  // move to next after short delay
  setTimeout(()=>{ showTestItem(testIndex+1); }, 420);
}

function onSkip(){
  score -= 2; updateScore();
  AudioSynth.wrong();
  setTimeout(()=>{ showTestItem(testIndex+1); }, 220);
}

function clearTestUI(){ optionsWrap.innerHTML=''; document.getElementById('fillInput').value=''; fillWrap.style.display='none'; }

function endTest(){
  clearInterval(timerInterval);
  setProgress(1);
  summaryScore.textContent = score;
  summaryTitle.textContent = getTitle(score);
  summaryText.textContent = `B·∫°n ƒë√£ ho√†n th√†nh. T·ªïng: ${score} ƒëi·ªÉm.`;
  summaryOverlay.classList.add('show');
  saveScoreToFirestore(score);
  AudioSynth.finish();
}

function getTitle(x){ if(x<=40) return "H√£y c·ªë g·∫Øng h·∫øt s·ª©c nh√© !!"; if(x<=100) return "Continue your Streak !!!"; if(x<=190) return "Ph√° v·ª° m·ªçi gi·ªõi h·∫°n."; return "Legend!"; }

// persistence
async function saveScoreToFirestore(sc){
  if(!currentUser) return;
  try{
    const ref = db.collection('scores').doc();
    await ref.set({ uid: currentUser.uid, name: currentUser.displayName||currentUser.email, score: sc, playedAt: firebase.firestore.FieldValue.serverTimestamp(), level: levelSelect.value });
    console.log('Saved score');
  }catch(e){ console.warn('Save score failed', e); }
}

// summary actions
btnRetry.addEventListener('click', ()=>{
  summaryOverlay.classList.remove('show');
  prepareTest();
  showTestStage();
});
btnHome.addEventListener('click', ()=>{ location.reload(); });

// helpers
function setProgress(frac){ progressBar.style.width = `${Math.round(frac*100)}%`; }
function updateScore(){ scoreDisplay.textContent = score; }

// init simple handlers
document.getElementById('flipBtn').addEventListener('click', ()=>{ card.classList.toggle('flipped'); AudioSynth.click(); });
document.getElementById('card').addEventListener('click', (e)=>{ if(e.target.tagName.toLowerCase()==='button') return; card.classList.toggle('flipped'); AudioSynth.click(); });
document.getElementById('nextBtn').addEventListener('click', ()=>{ studyIndex++; if(studyIndex>=studyPool.length) transitionToTest(); else showStudyCard(studyIndex); });

// enter key for fill
document.getElementById('fillInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); document.getElementById('submitFill').click(); } });

</script>
</body>
</html>
